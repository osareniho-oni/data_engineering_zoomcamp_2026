# ============================================================================
# WORKFLOW METADATA
# ============================================================================
# Loads parquet data from GCS into BigQuery with explicit schema handling
# Prevents schema drift issues by using predefined table schemas and MERGE operations

id: load_to_bq
namespace: zoomcamp.subflows

description: |
  Loads parquet data from GCS into BigQuery using explicit schemas.
  Handles yellow and green taxis with proper time partitioning and deduplication.
  Prevents schema drift by creating tables with fixed schemas before loading data.

# ============================================================================
# USER INPUTS
# ============================================================================
# Parameters passed from the parent workflow
# - taxi: The taxi type (yellow or green)
# - gcs_object: The GCS object path (e.g., yellow_tripdata_2019-01.parquet)

inputs:
  - id: taxi
    type: STRING
    description: Taxi type - either 'yellow' or 'green'
    
  - id: gcs_object
    type: STRING
    description: GCS object path relative to bucket

# ============================================================================
# WORKFLOW VARIABLES
# ============================================================================
# Defines reusable variables for GCP project, dataset, and table references

variables:
  project: dlt-bigquery-484316
  dataset: wk1_tf_dataset
  bucket: wk1-tf-bucket

# ============================================================================
# TASKS
# ============================================================================
# The workflow tasks execute in sequence to load and merge data into BigQuery

tasks:
  # --------------------------------------------------------------------------
  # TASK 1: Process Yellow Taxi Data (Conditional)
  # --------------------------------------------------------------------------
  # Executes only if taxi type is 'yellow'
  # Creates tables with explicit schema and loads data using MERGE to prevent duplicates
  
  - id: if_yellow_taxi
    type: io.kestra.plugin.core.flow.If
    condition: "{{ inputs.taxi == 'yellow' }}"
    then:
      # ------------------------------------------------------------------------
      # SUBTASK 1.1: Create Yellow Taxi Main Table
      # ------------------------------------------------------------------------
      # Creates the partitioned main table with explicit schema if it doesn't exist
      # This prevents schema drift issues across different months
      
      - id: create_yellow_main_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE TABLE IF NOT EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata`
          (
              unique_row_id BYTES OPTIONS (description = 'A unique identifier for the trip, generated by hashing key trip attributes.'),
              filename STRING OPTIONS (description = 'The source filename from which the trip data was loaded.'),      
              VendorID STRING OPTIONS (description = 'A code indicating the LPEP provider that provided the record. 1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.'),
              tpep_pickup_datetime TIMESTAMP OPTIONS (description = 'The date and time when the meter was engaged'),
              tpep_dropoff_datetime TIMESTAMP OPTIONS (description = 'The date and time when the meter was disengaged'),
              passenger_count INTEGER OPTIONS (description = 'The number of passengers in the vehicle. This is a driver-entered value.'),
              trip_distance NUMERIC OPTIONS (description = 'The elapsed trip distance in miles reported by the taximeter.'),
              RatecodeID STRING OPTIONS (description = 'The final rate code in effect at the end of the trip. 1= Standard rate 2=JFK 3=Newark 4=Nassau or Westchester 5=Negotiated fare 6=Group ride'),
              store_and_fwd_flag STRING OPTIONS (description = 'This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka "store and forward," because the vehicle did not have a connection to the server. TRUE = store and forward trip, FALSE = not a store and forward trip'),
              PULocationID STRING OPTIONS (description = 'TLC Taxi Zone in which the taximeter was engaged'),
              DOLocationID STRING OPTIONS (description = 'TLC Taxi Zone in which the taximeter was disengaged'),
              payment_type INTEGER OPTIONS (description = 'A numeric code signifying how the passenger paid for the trip. 1= Credit card 2= Cash 3= No charge 4= Dispute 5= Unknown 6= Voided trip'),
              fare_amount NUMERIC OPTIONS (description = 'The time-and-distance fare calculated by the meter'),
              extra NUMERIC OPTIONS (description = 'Miscellaneous extras and surcharges. Currently, this only includes the $0.50 and $1 rush hour and overnight charges'),
              mta_tax NUMERIC OPTIONS (description = '$0.50 MTA tax that is automatically triggered based on the metered rate in use'),
              tip_amount NUMERIC OPTIONS (description = 'Tip amount. This field is automatically populated for credit card tips. Cash tips are not included.'),
              tolls_amount NUMERIC OPTIONS (description = 'Total amount of all tolls paid in trip.'),
              improvement_surcharge NUMERIC OPTIONS (description = '$0.30 improvement surcharge assessed on hailed trips at the flag drop. The improvement surcharge began being levied in 2015.'),
              total_amount NUMERIC OPTIONS (description = 'The total amount charged to passengers. Does not include cash tips.'),
              congestion_surcharge NUMERIC OPTIONS (description = 'Congestion surcharge applied to trips in congested zones'),
              airport_fee NUMERIC OPTIONS (description = 'Airport fee for trips to/from airports')
          )
          PARTITION BY DATE(tpep_pickup_datetime)
          CLUSTER BY PULocationID, DOLocationID;

      # ------------------------------------------------------------------------
      # SUBTASK 1.2: Create Yellow Taxi External Table
      # ------------------------------------------------------------------------
      # Creates an external table pointing to the parquet file in GCS
      # This allows BigQuery to query the parquet directly without loading it first
      
      - id: create_yellow_external_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE OR REPLACE EXTERNAL TABLE `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`
          OPTIONS (
              format = 'PARQUET',
              uris = ['gs://{{ vars.bucket }}/{{ inputs.gcs_object }}']
          );

      # ------------------------------------------------------------------------
      # SUBTASK 1.3: Create Yellow Taxi Temporary Table with Unique IDs
      # ------------------------------------------------------------------------
      # Creates a temporary table from the external table
      # Adds unique_row_id (MD5 hash) and filename for deduplication
      # Handles missing columns gracefully with COALESCE
      
      - id: create_yellow_temp_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE OR REPLACE TABLE `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}`
          AS
          SELECT
            MD5(CONCAT(
              COALESCE(CAST(VendorID AS STRING), ""),
              COALESCE(CAST(tpep_pickup_datetime AS STRING), ""),
              COALESCE(CAST(tpep_dropoff_datetime AS STRING), ""),
              COALESCE(CAST(PULocationID AS STRING), ""),
              COALESCE(CAST(DOLocationID AS STRING), "")
            )) AS unique_row_id,
            "{{ inputs.gcs_object }}" AS filename,
            CAST(VendorID AS STRING) AS VendorID,
            tpep_pickup_datetime,
            tpep_dropoff_datetime,
            CAST(passenger_count AS INTEGER) AS passenger_count,
            CAST(trip_distance AS NUMERIC) AS trip_distance,
            CAST(RatecodeID AS STRING) AS RatecodeID,
            store_and_fwd_flag,
            CAST(PULocationID AS STRING) AS PULocationID,
            CAST(DOLocationID AS STRING) AS DOLocationID,
            CAST(payment_type AS INTEGER) AS payment_type,
            CAST(fare_amount AS NUMERIC) AS fare_amount,
            CAST(extra AS NUMERIC) AS extra,
            CAST(mta_tax AS NUMERIC) AS mta_tax,
            CAST(tip_amount AS NUMERIC) AS tip_amount,
            CAST(tolls_amount AS NUMERIC) AS tolls_amount,
            CAST(improvement_surcharge AS NUMERIC) AS improvement_surcharge,
            CAST(total_amount AS NUMERIC) AS total_amount,
            CAST(congestion_surcharge AS NUMERIC) AS congestion_surcharge,
            -- Handle optional airport_fee column that may not exist in older data
            CAST(COALESCE(airport_fee, 0) AS NUMERIC) AS airport_fee
          FROM `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`;

      # ------------------------------------------------------------------------
      # SUBTASK 1.4: Merge Yellow Taxi Data into Main Table
      # ------------------------------------------------------------------------
      # Performs a MERGE operation to insert only new records (no duplicates)
      # Uses unique_row_id to identify existing records
      
      - id: merge_yellow_data
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          MERGE INTO `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata` T
          USING `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}` S
          ON T.unique_row_id = S.unique_row_id
          WHEN NOT MATCHED THEN
            INSERT (unique_row_id, filename, VendorID, tpep_pickup_datetime, tpep_dropoff_datetime, passenger_count, trip_distance, RatecodeID, store_and_fwd_flag, PULocationID, DOLocationID, payment_type, fare_amount, extra, mta_tax, tip_amount, tolls_amount, improvement_surcharge, total_amount, congestion_surcharge, airport_fee)
            VALUES (S.unique_row_id, S.filename, S.VendorID, S.tpep_pickup_datetime, S.tpep_dropoff_datetime, S.passenger_count, S.trip_distance, S.RatecodeID, S.store_and_fwd_flag, S.PULocationID, S.DOLocationID, S.payment_type, S.fare_amount, S.extra, S.mta_tax, S.tip_amount, S.tolls_amount, S.improvement_surcharge, S.total_amount, S.congestion_surcharge, S.airport_fee);

      # ------------------------------------------------------------------------
      # SUBTASK 1.5: Cleanup Yellow Taxi Temporary Tables
      # ------------------------------------------------------------------------
      # Drops the temporary and external tables to save storage costs
      
      - id: cleanup_yellow_tables
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          DROP TABLE IF EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}`;
          DROP TABLE IF EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`;

  # --------------------------------------------------------------------------
  # TASK 2: Process Green Taxi Data (Conditional)
  # --------------------------------------------------------------------------
  # Executes only if taxi type is 'green'
  # Creates tables with explicit schema and loads data using MERGE to prevent duplicates
  
  - id: if_green_taxi
    type: io.kestra.plugin.core.flow.If
    condition: "{{ inputs.taxi == 'green' }}"
    then:
      # ------------------------------------------------------------------------
      # SUBTASK 2.1: Create Green Taxi Main Table
      # ------------------------------------------------------------------------
      # Creates the partitioned main table with explicit schema if it doesn't exist
      # This prevents schema drift issues across different months
      
      - id: create_green_main_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE TABLE IF NOT EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata`
          (
              unique_row_id BYTES OPTIONS (description = 'A unique identifier for the trip, generated by hashing key trip attributes.'),
              filename STRING OPTIONS (description = 'The source filename from which the trip data was loaded.'),      
              VendorID STRING OPTIONS (description = 'A code indicating the LPEP provider that provided the record. 1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.'),
              lpep_pickup_datetime TIMESTAMP OPTIONS (description = 'The date and time when the meter was engaged'),
              lpep_dropoff_datetime TIMESTAMP OPTIONS (description = 'The date and time when the meter was disengaged'),
              store_and_fwd_flag STRING OPTIONS (description = 'This flag indicates whether the trip record was held in vehicle memory before sending to the vendor, aka "store and forward," because the vehicle did not have a connection to the server. Y= store and forward trip N= not a store and forward trip'),
              RatecodeID STRING OPTIONS (description = 'The final rate code in effect at the end of the trip. 1= Standard rate 2=JFK 3=Newark 4=Nassau or Westchester 5=Negotiated fare 6=Group ride'),
              PULocationID STRING OPTIONS (description = 'TLC Taxi Zone in which the taximeter was engaged'),
              DOLocationID STRING OPTIONS (description = 'TLC Taxi Zone in which the taximeter was disengaged'),
              passenger_count INT64 OPTIONS (description = 'The number of passengers in the vehicle. This is a driver-entered value.'),
              trip_distance NUMERIC OPTIONS (description = 'The elapsed trip distance in miles reported by the taximeter.'),
              fare_amount NUMERIC OPTIONS (description = 'The time-and-distance fare calculated by the meter'),
              extra NUMERIC OPTIONS (description = 'Miscellaneous extras and surcharges. Currently, this only includes the $0.50 and $1 rush hour and overnight charges'),
              mta_tax NUMERIC OPTIONS (description = '$0.50 MTA tax that is automatically triggered based on the metered rate in use'),
              tip_amount NUMERIC OPTIONS (description = 'Tip amount. This field is automatically populated for credit card tips. Cash tips are not included.'),
              tolls_amount NUMERIC OPTIONS (description = 'Total amount of all tolls paid in trip.'),
              ehail_fee NUMERIC,
              improvement_surcharge NUMERIC OPTIONS (description = '$0.30 improvement surcharge assessed on hailed trips at the flag drop. The improvement surcharge began being levied in 2015.'),
              total_amount NUMERIC OPTIONS (description = 'The total amount charged to passengers. Does not include cash tips.'),
              payment_type INTEGER OPTIONS (description = 'A numeric code signifying how the passenger paid for the trip. 1= Credit card 2= Cash 3= No charge 4= Dispute 5= Unknown 6= Voided trip'),
              trip_type STRING OPTIONS (description = 'A code indicating whether the trip was a street-hail or a dispatch that is automatically assigned based on the metered rate in use but can be altered by the driver. 1= Street-hail 2= Dispatch'),
              congestion_surcharge NUMERIC OPTIONS (description = 'Congestion surcharge applied to trips in congested zones')
          )
          PARTITION BY DATE(lpep_pickup_datetime)
          CLUSTER BY PULocationID, DOLocationID;

      # ------------------------------------------------------------------------
      # SUBTASK 2.2: Create Green Taxi External Table
      # ------------------------------------------------------------------------
      # Creates an external table pointing to the parquet file in GCS
      # This allows BigQuery to query the parquet directly without loading it first
      
      - id: create_green_external_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE OR REPLACE EXTERNAL TABLE `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`
          OPTIONS (
              format = 'PARQUET',
              uris = ['gs://{{ vars.bucket }}/{{ inputs.gcs_object }}']
          );

      # ------------------------------------------------------------------------
      # SUBTASK 2.3: Create Green Taxi Temporary Table with Unique IDs
      # ------------------------------------------------------------------------
      # Creates a temporary table from the external table
      # Adds unique_row_id (MD5 hash) and filename for deduplication
      # Handles missing columns gracefully with COALESCE
      
      - id: create_green_temp_table
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          CREATE OR REPLACE TABLE `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}`
          AS
          SELECT
            MD5(CONCAT(
              COALESCE(CAST(VendorID AS STRING), ""),
              COALESCE(CAST(lpep_pickup_datetime AS STRING), ""),
              COALESCE(CAST(lpep_dropoff_datetime AS STRING), ""),
              COALESCE(CAST(PULocationID AS STRING), ""),
              COALESCE(CAST(DOLocationID AS STRING), "")
            )) AS unique_row_id,
            "{{ inputs.gcs_object }}" AS filename,
            CAST(VendorID AS STRING) AS VendorID,
            lpep_pickup_datetime,
            lpep_dropoff_datetime,
            store_and_fwd_flag,
            CAST(RatecodeID AS STRING) AS RatecodeID,
            CAST(PULocationID AS STRING) AS PULocationID,
            CAST(DOLocationID AS STRING) AS DOLocationID,
            CAST(passenger_count AS INT64) AS passenger_count,
            CAST(trip_distance AS NUMERIC) AS trip_distance,
            CAST(fare_amount AS NUMERIC) AS fare_amount,
            CAST(extra AS NUMERIC) AS extra,
            CAST(mta_tax AS NUMERIC) AS mta_tax,
            CAST(tip_amount AS NUMERIC) AS tip_amount,
            CAST(tolls_amount AS NUMERIC) AS tolls_amount,
            -- Handle optional ehail_fee column that may not exist in all data
            CAST(COALESCE(ehail_fee, 0) AS NUMERIC) AS ehail_fee,
            CAST(improvement_surcharge AS NUMERIC) AS improvement_surcharge,
            CAST(total_amount AS NUMERIC) AS total_amount,
            CAST(payment_type AS INTEGER) AS payment_type,
            CAST(trip_type AS STRING) AS trip_type,
            CAST(congestion_surcharge AS NUMERIC) AS congestion_surcharge
          FROM `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`;

      # ------------------------------------------------------------------------
      # SUBTASK 2.4: Merge Green Taxi Data into Main Table
      # ------------------------------------------------------------------------
      # Performs a MERGE operation to insert only new records (no duplicates)
      # Uses unique_row_id to identify existing records
      
      - id: merge_green_data
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          MERGE INTO `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata` T
          USING `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}` S
          ON T.unique_row_id = S.unique_row_id
          WHEN NOT MATCHED THEN
            INSERT (unique_row_id, filename, VendorID, lpep_pickup_datetime, lpep_dropoff_datetime, store_and_fwd_flag, RatecodeID, PULocationID, DOLocationID, passenger_count, trip_distance, fare_amount, extra, mta_tax, tip_amount, tolls_amount, ehail_fee, improvement_surcharge, total_amount, payment_type, trip_type, congestion_surcharge)
            VALUES (S.unique_row_id, S.filename, S.VendorID, S.lpep_pickup_datetime, S.lpep_dropoff_datetime, S.store_and_fwd_flag, S.RatecodeID, S.PULocationID, S.DOLocationID, S.passenger_count, S.trip_distance, S.fare_amount, S.extra, S.mta_tax, S.tip_amount, S.tolls_amount, S.ehail_fee, S.improvement_surcharge, S.total_amount, S.payment_type, S.trip_type, S.congestion_surcharge);

      # ------------------------------------------------------------------------
      # SUBTASK 2.5: Cleanup Green Taxi Temporary Tables
      # ------------------------------------------------------------------------
      # Drops the temporary and external tables to save storage costs
      
      - id: cleanup_green_tables
        type: io.kestra.plugin.gcp.bigquery.Query
        projectId: "{{ vars.project }}"
        sql: |
          DROP TABLE IF EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}`;
          DROP TABLE IF EXISTS `{{ vars.project }}.{{ vars.dataset }}.{{ inputs.taxi }}_tripdata_{{ inputs.gcs_object | split('/') | last | split('_') | last | split('.') | first | replace('-', '_') }}_ext`;

# ============================================================================
# PLUGIN DEFAULTS
# ============================================================================
# Sets default configuration for all GCP plugin tasks
# Note: Credentials should be configured at the namespace or global level

pluginDefaults:
  - type: io.kestra.plugin.gcp
    values:
      projectId: "{{ vars.project }}"
