id: nyc_taxi_parent
namespace: zoomcamp

description: |
  Parent orchestration flow for NYC Taxi data.
  Supports:
    - Manual year-range backfills
    - Manual month-specific backfills
    - Automatic scheduled monthly runs
    - Yellow or Green datasets

inputs:
  - id: taxi
    type: SELECT
    values: [yellow, green]
    defaults: yellow

  - id: start_year
    type: INT
    defaults: 2019

  - id: end_year
    type: INT
    defaults: 2021

  - id: months
    type: ARRAY
    itemType: STRING
    required: false
    description: "Optional list of months to process (e.g. ['01','02','03'])"

triggers:
  - id: yellow_monthly
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "0 2 1 * *"
    inputs:
      taxi: yellow
      start_year: "{{ now().minusMonths(1).year }}"
      end_year: "{{ now().minusMonths(1).year }}"
      months:
        - "{{ now().minusMonths(1).format('MM') }}"

  - id: green_monthly
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "0 3 1 * *"
    inputs:
      taxi: green
      start_year: "{{ now().minusMonths(1).year }}"
      end_year: "{{ now().minusMonths(1).year }}"
      months:
        - "{{ now().minusMonths(1).format('MM') }}"

tasks:
  - id: years
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ range(inputs.start_year, inputs.end_year) }}"
    tasks:

      - id: months
        type: io.kestra.plugin.core.flow.ForEach
        values: >-
          {% if inputs.months is defined and inputs.months|length > 0 %}
            {{ inputs.months }}
          {% else %}
            ["01","02","03","04","05","06","07","08","09","10","11","12"]
          {% endif %}
        tasks:

          - id: ingest
            type: io.kestra.plugin.core.flow.Subflow
            flowId: ingest_to_gcs
            namespace: zoomcamp.subflows
            inputs:
              taxi: "{{ inputs.taxi }}"
              year: "{{ parent.taskrun.value }}"
              month: "{{ taskrun.value }}"

          - id: load
            type: io.kestra.plugin.core.flow.Subflow
            flowId: load_to_bq
            namespace: zoomcamp.subflows
            inputs:
              taxi: "{{ inputs.taxi }}"
              gcs_object: "{{ inputs.taxi }}/year={{ parent.taskrun.value }}/month={{ taskrun.value }}/{{ inputs.taxi }}_tripdata_{{ parent.taskrun.value }}-{{ taskrun.value }}.parquet"

